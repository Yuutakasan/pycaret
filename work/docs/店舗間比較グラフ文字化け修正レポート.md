# 店舗間比較グラフ文字化け修正レポート

**作成日**: 2025年10月9日
**対象**: Phase1 【機能5】店舗間パフォーマンス比較
**修正者**: Claude Code

---

## 🔍 問題の特定

### ユーザーからの報告

```
店舗間比較のグラフが文字化けしています。修正してください。
```

実行時のエラー出力:
```
【機能5】店舗間パフォーマンス比較
findfont: Generic family 'sans-serif' not found...
(warnings repeated 5 times)
```

### 問題の原因

**Phase1 Cell 19** の店舗間比較グラフで、`pandas.DataFrame.plot()` メソッドを使用してグラフを作成していたが、この方法では:

1. **x軸に日本語の列名「店舗」を指定**
2. **y軸のticklabels（店舗名）がpandasによって自動生成**
3. **自動生成されたticklabelsには日本語フォント設定が適用されない**

結果として、y軸に表示される店舗名（日本語）が文字化けしていた。

### 該当コード（修正前）

```python
# 1. 平均日商比較
ax1 = axes[0]
store_summary.plot(x='店舗', y='平均日商', kind='barh', ax=ax1, color=colors, legend=False)
ax1.set_title('平均日商比較', fontsize=14, fontproperties=JP_FP)
ax1.set_xlabel('売上金額（円）', fontsize=12, fontproperties=JP_FP)
ax1.set_ylabel('', fontproperties=JP_FP)
ax1.grid(axis='x', alpha=0.3)
# ❌ y軸のticklabels（店舗名）にフォント設定なし

# 2. 平均客単価比較
ax2 = axes[1]
store_summary.plot(x='店舗', y='平均客単価', kind='barh', ax=ax2, color=colors, legend=False)
ax2.set_title('平均客単価 顧客あたり', fontsize=14, fontproperties=JP_FP)
ax2.text(0.5, 0.95, "💡 目標客単価と比較してください", ...)
ax2.set_xlabel('円', fontsize=12, fontproperties=JP_FP)
ax2.set_ylabel('', fontproperties=JP_FP)
ax2.grid(axis='x', alpha=0.3)
# ❌ y軸のticklabels（店舗名）にフォント設定なし

# 3. ギャップ可視化
ax3 = axes[2]
gap_data = store_summary.copy()
gap_data['ギャップ'] = top_store_sales - gap_data['平均日商']
gap_data.plot(x='店舗', y='ギャップ', kind='barh', ax=ax3, color=colors, legend=False)
ax3.set_title('トップ店舗とのギャップ', fontsize=14, fontproperties=JP_FP)
ax3.set_xlabel('ギャップ（円）', fontsize=12, fontproperties=JP_FP)
ax3.set_ylabel('', fontproperties=JP_FP)
ax3.grid(axis='x', alpha=0.3)
# ❌ y軸のticklabels（店舗名）にフォント設定なし
```

---

## ✅ 実施した修正

### 修正内容

各グラフの `ax.grid()` 呼び出し直後に、**y軸ticklabelsに明示的に日本語フォントを適用**するコードを追加:

```python
for label in ax.get_yticklabels():
    label.set_fontproperties(JP_FP)
```

### 修正後のコード

```python
# 1. 平均日商比較
ax1 = axes[0]
store_summary.plot(x='店舗', y='平均日商', kind='barh', ax=ax1, color=colors, legend=False)
ax1.set_title('平均日商比較', fontsize=14, fontproperties=JP_FP)
ax1.set_xlabel('売上金額（円）', fontsize=12, fontproperties=JP_FP)
ax1.set_ylabel('', fontproperties=JP_FP)
ax1.grid(axis='x', alpha=0.3)
for label in ax1.get_yticklabels():  # ✅ 追加
    label.set_fontproperties(JP_FP)  # ✅ 追加

# 2. 平均客単価比較
ax2 = axes[1]
store_summary.plot(x='店舗', y='平均客単価', kind='barh', ax=ax2, color=colors, legend=False)
ax2.set_title('平均客単価 顧客あたり', fontsize=14, fontproperties=JP_FP)
ax2.text(0.5, 0.95, "💡 目標客単価と比較してください", ...)
ax2.set_xlabel('円', fontsize=12, fontproperties=JP_FP)
ax2.set_ylabel('', fontproperties=JP_FP)
ax2.grid(axis='x', alpha=0.3)
for label in ax2.get_yticklabels():  # ✅ 追加
    label.set_fontproperties(JP_FP)  # ✅ 追加

# 3. ギャップ可視化
ax3 = axes[2]
gap_data = store_summary.copy()
gap_data['ギャップ'] = top_store_sales - gap_data['平均日商']
gap_data.plot(x='店舗', y='ギャップ', kind='barh', ax=ax3, color=colors, legend=False)
ax3.set_title('トップ店舗とのギャップ', fontsize=14, fontproperties=JP_FP)
ax3.set_xlabel('ギャップ（円）', fontsize=12, fontproperties=JP_FP)
ax3.set_ylabel('', fontproperties=JP_FP)
ax3.grid(axis='x', alpha=0.3)
for label in ax3.get_yticklabels():  # ✅ 追加
    label.set_fontproperties(JP_FP)  # ✅ 追加
```

---

## 🛠️ 修正ツール

### スクリプト名
`scripts/fix_store_comparison_mojibake.py`

### 処理内容
1. Phase1ノートブックのCell 19を検出
2. 各グラフの `ax.grid()` 行の直後にticklabelsフォント設定を挿入
3. 修正済みノートブックを保存

### 実行結果

```
================================================================================
                               🔧 店舗間比較グラフの文字化け修正
================================================================================

📝 店舗別包括ダッシュボード_v5.0_Phase1.ipynb
✅ 店舗間比較グラフに日本語フォント設定を追加しました

修正内容:
  ・ax1（平均日商比較）のy軸ticklabelsにJP_FP適用
  ・ax2（平均客単価比較）のy軸ticklabelsにJP_FP適用
  ・ax3（ギャップ可視化）のy軸ticklabelsにJP_FP適用

================================================================================
```

---

## 📊 修正箇所まとめ

| グラフ名 | 修正内容 | 適用場所 |
|---------|---------|---------|
| **平均日商比較** (ax1) | y軸ticklabelsにJP_FP適用 | Cell 19, Line 104-105 |
| **平均客単価比較** (ax2) | y軸ticklabelsにJP_FP適用 | Cell 19, Line 115-116 |
| **トップ店舗とのギャップ** (ax3) | y軸ticklabelsにJP_FP適用 | Cell 19, Line 127-128 |

**修正総数**: 3箇所（3つのグラフ）

---

## 🔍 技術的な詳細

### pandas.DataFrame.plot() の挙動

`pandas.DataFrame.plot()` メソッドは内部でmatplotlibを使用してグラフを作成するが:

1. **x軸に指定した列の値**（この場合「店舗」列の店舗名）が**自動的にticklabelsとして設定**される
2. これらのticklabelsは**matplotlibのデフォルトフォント**で描画される
3. `set_xlabel()` や `set_title()` で設定する**軸ラベルやタイトルとは別物**

### なぜ明示的な設定が必要か

```python
ax.set_ylabel('', fontproperties=JP_FP)  # ❌ これだけでは不十分
```

`set_ylabel()` は**軸ラベル（Axis Label）**のフォントを設定するが、**ticklabels（目盛りラベル）**のフォントは設定されない。

```python
for label in ax.get_yticklabels():  # ✅ ticklabelsを直接取得
    label.set_fontproperties(JP_FP)  # ✅ 各ラベルにフォント設定
```

この方法で、y軸に表示される各店舗名（ticklabels）に日本語フォントが適用される。

---

## 🎯 今後の対策

### CLAUDE.mdへの追記（既存ルールの拡張）

既存の「🚨 CRITICAL: Japanese Font & Mojibake Prevention」セクションに以下を追記:

```markdown
9. **pandas.plot() with Japanese column names** - ALWAYS set fontproperties for tick labels

**Wrong:**
```python
df.plot(x='店舗', y='売上', kind='barh', ax=ax)  # ❌ tick labels will be mojibake
```

**Correct:**
```python
df.plot(x='店舗', y='売上', kind='barh', ax=ax)
for label in ax.get_yticklabels():  # ✅
    label.set_fontproperties(JP_FP)  # ✅
# Also for x-axis if it contains Japanese:
for label in ax.get_xticklabels():  # ✅
    label.set_fontproperties(JP_FP)  # ✅
```
```

---

## ✅ 検証

### 修正確認コマンド

```bash
python3 -c "
import json
with open('店舗別包括ダッシュボード_v5.0_Phase1.ipynb', 'r') as f:
    nb = json.load(f)
cell = nb['cells'][19]
source = ''.join(cell['source'])
# 'for label in ax' が3回登場すればOK
import re
count = len(re.findall(r'for label in ax\d\.get_yticklabels', source))
print(f'✅ ticklabelsフォント設定: {count}/3箇所')
"
```

### 期待される出力

```
✅ ticklabelsフォント設定: 3/3箇所
```

---

## 📝 まとめ

### 問題点
- 店舗間比較グラフの3つのサブプロット（平均日商、客単価、ギャップ）のy軸に表示される店舗名が文字化け

### 原因
- `pandas.DataFrame.plot()` で生成されるticklabelsに日本語フォント設定が適用されていなかった

### 解決策
- 各サブプロットの作成後、`ax.get_yticklabels()` で取得したラベルに `set_fontproperties(JP_FP)` を適用

### 影響範囲
- Phase1 Cell 19 のみ（3箇所修正）

### 今後の予防策
- CLAUDE.mdに `pandas.plot()` 使用時のticklabelsフォント設定ルールを追加
- 同様のパターンがあれば同じ修正を適用

---

**ステータス**: ✅ 修正完了
**テスト**: 実行待ち（ユーザーによるJupyter Lab上での再実行）
**次のステップ**: ユーザーに再実行を依頼し、文字化けが解消されたことを確認
