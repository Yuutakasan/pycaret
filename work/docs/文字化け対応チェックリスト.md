# 日本語文字化け対応チェックリスト

## 🔍 現在の状況

修正スクリプトを実行済みだが、文字化けが再発しているとのこと。

## ✅ 確認済み項目

1. **ヘッダーセル（cell-1）の内容** - ✅ 正常
   - `from datetime import datetime, timedelta` ✅
   - `japanize_matplotlib.japanize()` ✅ 呼び出されている
   - 代替フォント設定 ✅ 正常

2. **PyCaretの設定** - ✅ 修正済み
   - `data_split_shuffle=False` ✅
   - `fold_shuffle=False` ✅

## 🚨 文字化けの原因候補

### 原因1: カーネル再起動していない（最も可能性が高い）

**症状:**
- ヘッダーセルは正しく設定されている
- しかし、Jupyter Notebookのカーネルが古い状態のまま

**対処法:**
```
Jupyter Lab メニュー → Kernel → Restart Kernel and Run All Cells...
```

### 原因2: japanize_matplotlibがインストールされていない

**確認方法:**
```bash
pip list | grep japanize
```

**インストール方法:**
```bash
pip install japanize-matplotlib
```

### 原因3: セルを個別実行している

**症状:**
- ヘッダーセル（cell-1）を実行せずに、グラフ描画セル（cell-7など）だけを実行

**対処法:**
- 必ず上から順番に全セル実行
- または「Restart Kernel and Run All Cells」を使用

## 📋 推奨実行手順

### ステップ1: Jupyter Labを開く
```bash
cd /mnt/d/github/pycaret/work
jupyter lab
```

### ステップ2: Phase 1ノートブックを開く
`店舗別包括ダッシュボード_v5.0_Phase1.ipynb`を開く

### ステップ3: カーネル再起動＋全セル実行
メニューから: **Kernel** → **Restart Kernel and Run All Cells...**

### ステップ4: 実行結果を確認

**正常な場合:**
```
✅ 日本語表示: japanize_matplotlib
✅ 環境設定完了
✅ データ読み込み完了
...
```

**ヘッダーセルで以下が表示されたか確認:**
- ✅ `japanize_matplotlib.japanize()` が実行された
- ✅ `✅ 日本語表示: japanize_matplotlib` が表示された

### ステップ5: グラフを確認

セル7（エグゼクティブサマリーグラフ）で、以下を確認:
- `plt.suptitle(f'Executive Summary - {MY_STORE}', ...)` のタイトル
- `{MY_STORE}` の部分（店舗名）が日本語で正しく表示されているか

## 🔧 トラブルシューティング

### 問題: 依然として文字化けする

#### 確認1: japanize_matplotlibのバージョン
```bash
pip show japanize-matplotlib
```

最新版にアップデート:
```bash
pip install --upgrade japanize-matplotlib
```

#### 確認2: matplotlibのバージョン
```bash
pip show matplotlib
```

互換性のある組み合わせ:
- matplotlib 3.5.x + japanize-matplotlib 1.1.x
- matplotlib 3.6.x + japanize-matplotlib 1.1.x
- matplotlib 3.7.x + japanize-matplotlib 1.1.x

#### 確認3: フォントキャッシュをクリア
```python
# Jupyterノートブックの新しいセルで実行
import matplotlib as mpl
import matplotlib.font_manager as fm

# フォントキャッシュをクリア
fm._load_fontmanager(try_read_cache=False)

# 日本語フォントを確認
japanese_fonts = [f.name for f in fm.fontManager.ttflist if 'Gothic' in f.name or 'Noto Sans CJK' in f.name]
print("利用可能な日本語フォント:", japanese_fonts)
```

#### 確認4: ヘッダーセルを手動で再実行

1. Jupyter Labで cell-1（ヘッダーセル）を選択
2. Shift + Enter で実行
3. 以下が表示されることを確認:
   ```
   ✅ 日本語表示: japanize_matplotlib
   ```

### 問題: 特定のグラフだけ文字化けする

#### セル7（エグゼクティブサマリー）の場合

**確認箇所:**
```python
plt.suptitle(f'Executive Summary - {MY_STORE}', fontsize=18, y=0.98)
```

`{MY_STORE}`変数に日本語の店舗名が入っているか確認:
```python
# 新しいセルで確認
print(f"店舗名: {MY_STORE}")
print(f"店舗名の型: {type(MY_STORE)}")
```

## 🎯 最終確認チェックリスト

- [ ] `pip list | grep japanize` でjapanize-matplotlibがインストール済み
- [ ] Jupyter Labでノートブックを開いた
- [ ] **Kernel → Restart Kernel and Run All Cells...** を実行した
- [ ] cell-1で `✅ 日本語表示: japanize_matplotlib` が表示された
- [ ] cell-7のグラフタイトルで店舗名が正しく表示された
- [ ] 他のグラフ（cell-13, cell-15）でも日本語が正しく表示された

## 📞 それでも解決しない場合

### デバッグ用セルを追加

ノートブックの最後に以下のセルを追加して実行:

```python
# デバッグ情報
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm

print("="*80)
print("日本語フォント設定デバッグ情報")
print("="*80)

# 1. 現在のフォント設定
print(f"\n現在のフォントファミリー: {plt.rcParams['font.family']}")
print(f"unicode_minus設定: {plt.rcParams['axes.unicode_minus']}")

# 2. japanize_matplotlibの状態
try:
    import japanize_matplotlib
    print(f"\njapanize_matplotlib: インストール済み")
    print(f"バージョン: {japanize_matplotlib.__version__ if hasattr(japanize_matplotlib, '__version__') else '不明'}")
except ImportError:
    print(f"\njapanize_matplotlib: 未インストール ❌")

# 3. 利用可能な日本語フォント
japanese_fonts = [f.name for f in fm.fontManager.ttflist
                  if 'Gothic' in f.name or 'Noto Sans CJK' in f.name or 'IPA' in f.name]
print(f"\n利用可能な日本語フォント ({len(japanese_fonts)}個):")
for font in japanese_fonts[:10]:
    print(f"  • {font}")

# 4. テスト描画
fig, ax = plt.subplots(figsize=(8, 4))
test_text = f"テスト: {MY_STORE}"
ax.text(0.5, 0.5, test_text, fontsize=20, ha='center', va='center')
ax.set_title("日本語表示テスト", fontsize=16)
ax.axis('off')
plt.tight_layout()
plt.show()

print(f"\n✅ テスト描画完了。上のグラフで '{test_text}' が正しく表示されているか確認してください。")
```

このデバッグ情報をもとに、さらに詳細な対応が可能です。

---

**最終更新:** 2025年10月9日 05:10
