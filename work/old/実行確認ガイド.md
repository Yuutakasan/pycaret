# 🔍 Phase 1-4 ノートブック 実行確認ガイド

## 📅 修正完了日
2025年10月09日

---

## ✅ 実施した修正内容

### 1️⃣ 日本語フォント対応（ユーザー指摘事項）

**問題点（修正前）:**
```python
plt.rcParams['font.sans-serif'] = ['DejaVu Sans']  # ❌ 日本語非対応
```

**修正後:**
```python
# 日本語フォント
try:
    import japanize_matplotlib
    print("✅ 日本語表示: japanize_matplotlib")
except ImportError:
    plt.rcParams['font.family'] = ['Noto Sans CJK JP', 'IPAGothic', 'sans-serif']
    plt.rcParams['axes.unicode_minus'] = False
    print("⚠️ 代替フォント設定")
```

**利点:**
- japanize-matplotlibがあれば完全日本語対応
- なくてもNoto Sans CJK JP / IPAGothicで日本語表示（Linux/Mac標準）
- シンプルで保守しやすい設定

---

### 2️⃣ 店舗選択ウィジェット復活（ユーザー指摘事項）

**問題点:**
> "店舗別包括ダッシュボード_v4_enhanced.ipynbで出来ていた店舗を選んで調査する機能がなくなっている"

**修正内容:**
- ipywidgetsのDropdownウィジェットを全Phase に追加
- 店舗を選択すると、すべての分析が自動的にその店舗でフィルタ
- ウィジェットがない環境でもデフォルト店舗で動作

**追加されたコード:**
```python
# 店舗選択ウィジェット
if WIDGETS_AVAILABLE:
    store_dropdown = widgets.Dropdown(
        options=stores,
        value=DEFAULT_STORE,
        description='分析対象店舗:',
        ...
    )
    display(store_dropdown)
    MY_STORE = store_dropdown.value
else:
    MY_STORE = DEFAULT_STORE
```

---

### 3️⃣ データ検証機能追加（ユーザー指摘事項）

**問題点:**
> "データがないのにダッシュボードを空想で作っているケースがあります"

**修正内容:**
- 各ノートブックでデータ存在をチェック
- 必須カラムの有無を確認
- オプションカラム（気象、前年、時間帯）の有無を表示
- データがない場合は警告表示

**追加されたセル:**
```python
# データ検証セル
validate_data_column(df_enriched, '日付', '基本データ')
validate_data_column(df_enriched, '売上金額', '基本データ')
...
```

---

## 🔧 修正されたファイル

| ファイル | 修正内容 | バックアップ |
|---------|---------|------------|
| **Phase 1** | ヘッダー置換 + 店舗選択追加 + データ検証追加 | `.backup_20251009_034111.ipynb` |
| **Phase 2** | ヘッダー置換 + 店舗選択追加 + データ検証追加 | `.backup_20251009_034111.ipynb` |
| **Phase 3** | ヘッダー置換 + 店舗選択追加 + データ検証追加 | `.backup_20251009_034111.ipynb` |
| **Phase 4** | ヘッダー置換 + 店舗選択追加 + データ検証追加 | `.backup_20251009_034111.ipynb` |

**セル数の変化:**
- Phase 1: 15 → 17 セル
- Phase 2: 20 → 22 セル
- Phase 3: 19 → 21 セル
- Phase 4: 15 → 17 セル

---

## 🎯 実行確認手順（ユーザーに実施していただきたい）

### ステップ1: 環境準備（初回のみ）

```bash
# 日本語フォント対応
pip install japanize-matplotlib

# インタラクティブウィジェット
pip install ipywidgets
jupyter nbextension enable --py widgetsnbextension

# Jupyter Notebook再起動
jupyter notebook
```

### ステップ2: 各Phaseノートブックの実行

**Phase 1から順番に確認してください:**

1. **Phase 1を開く:**
   ```
   http://127.0.0.1:8888/lab/tree/work/店舗別包括ダッシュボード_v5.0_Phase1.ipynb
   ```

2. **「Restart & Run All」を実行**
   - メニュー: Kernel → Restart & Run All
   - または、ツールバーのアイコンをクリック

3. **以下を確認:**
   - ✅ セル1: ライブラリインポート成功
   - ✅ セル1の出力で「✅ 日本語表示: japanize_matplotlib」または「✅ 日本語表示: Windows標準フォント」が表示される
   - ✅ セル2: データ読み込み成功
   - ✅ セル3: 店舗選択ドロップダウンが表示される
   - ✅ セル4: データ検証メッセージが表示される
   - ✅ すべてのグラフで日本語が正しく表示される（文字化けなし）
   - ✅ エラーなく全セル実行完了

4. **店舗選択機能のテスト:**
   - セル3のドロップダウンで別の店舗を選択
   - セル4以降を再実行
   - 選択した店舗のデータで分析が実行されることを確認

5. **Phase 2, 3, 4でも同様に確認**

---

## ⚠️ よくある問題と対処法

### 問題1: 日本語が文字化けする（□□□で表示）

**原因:**
- japanize-matplotlibがインストールされていない
- システムフォントがない

**対処法:**
```bash
# 方法1: japanize-matplotlibをインストール
pip install japanize-matplotlib

# 方法2: システムフォントを確認
fc-list | grep -i gothic  # Linux/Mac
# Windows: C:\Windows\Fonts を確認

# 方法3: 環境変数を設定
export LANG=ja_JP.UTF-8
```

### 問題2: 店舗選択ドロップダウンが表示されない

**原因:**
- ipywidgetsがインストールされていない
- Jupyter拡張機能が有効化されていない

**対処法:**
```bash
pip install ipywidgets
jupyter nbextension enable --py widgetsnbextension
jupyter notebook  # 再起動
```

**回避策:**
デフォルト店舗で実行されます。セル3のコードを直接編集して店舗を指定できます：
```python
# MY_STORE = "店舗名" と手動で指定
MY_STORE = "東京店"  # 例
my_df = df_enriched[df_enriched['店舗'] == MY_STORE].copy()
```

### 問題3: データがないというエラーが出る

**原因:**
- `output/06_*.csv` ファイルが存在しない
- データ準備が未実施

**対処法:**
```bash
cd /mnt/d/github/pycaret/work

# データ変換
python batch_convert.py --input-dir input --output-dir output --debug

# 特徴量付与
python enrich_features_v2.py --input output/06_*.csv --output output/06_final_enriched_20250701_20250930.csv
```

### 問題4: 特定の分析でエラーが出る

**原因:**
- 必要なデータカラムが存在しない（時間帯データ、気象データなど）

**確認方法:**
セル4のデータ検証セルで以下をチェック：
```
✅ 必須カラム '日付' - 存在
✅ 必須カラム '売上金額' - 存在
✅ 必須カラム '店舗' - 存在
✅ 気象データ: 最高気温, 降水量
⚠️ 時間帯データ: 利用不可（代替ロジック使用）
```

**対処:**
- ⚠️マークがついている分析は代替ロジックで実行されます
- より詳細な分析には、データ収集の改善が必要です

---

## 📊 データ検証スクリプトの実行（推奨）

ノートブック実行前に、データの完全性をチェックできます：

```bash
python3 scripts/validate_notebook_data.py
```

**出力例:**
```
================================================================================
🔍 Phase 1-4 データ存在検証スクリプト
================================================================================

📂 データファイル: 06_final_enriched_20250701_20250930.csv
✅ データ読み込み成功: 125,432行 x 250列

================================================================================
📊 Phase 1: 毎日の基本業務 - データ検証
================================================================================
✅ Phase 1基本データ: データ利用可能 (125,432行)
✅ Phase 1必須カラム: 必須カラム存在確認
✅ 気象データ: 利用可能
✅ 前年データ: 利用可能（カバレッジ: 92.4%）
   ⚠️ カバレッジが90%未満

================================================================================
📋 検証サマリー
================================================================================
Phase 1: 4/4 項目OK
Phase 2: 4/4 項目OK
Phase 3: 3/4 項目OK
Phase 4: 3/4 項目OK
```

---

## 📝 チェックリスト

### 環境準備
- [ ] japanize-matplotlibインストール完了
- [ ] ipywidgetsインストール完了
- [ ] Jupyter拡張機能有効化完了
- [ ] データファイル（`output/06_*.csv`）準備完了

### Phase 1 実行確認
- [ ] ノートブックを開ける
- [ ] 「Restart & Run All」実行
- [ ] 日本語が正しく表示される
- [ ] 店舗選択ドロップダウンが表示される
- [ ] データ検証メッセージが表示される
- [ ] エラーなく全セル実行完了
- [ ] 店舗を切り替えて再実行できる

### Phase 2 実行確認
- [ ] Phase 1と同様の確認項目

### Phase 3 実行確認
- [ ] Phase 1と同様の確認項目

### Phase 4 実行確認
- [ ] Phase 1と同様の確認項目

---

## 🎉 全て確認できたら

おめでとうございます！Phase 1-4のダッシュボードが正常に動作しています。

### 次のステップ

1. **毎日の運用を開始**
   - 実務向けクイックスタート.mdを参照
   - 朝：Phase 1エグゼクティブサマリー確認
   - 午前：需要予測で発注計画
   - 週1回：Phase 3で深掘り分析

2. **データ更新の自動化**
   ```bash
   # cronで毎日実行
   0 5 * * * cd /path/to/pycaret/work && python batch_convert.py && python enrich_features_v2.py
   ```

3. **複数店舗の管理**
   - 店舗選択ウィジェットで各店舗を分析
   - 結果をPDF保存して本部報告

---

## 🚨 問題が発生した場合

### バックアップから復元

修正前のノートブックは自動的にバックアップされています：
```bash
cd /mnt/d/github/pycaret/work

# バックアップファイルを確認
ls -l *.backup_*.ipynb

# 復元（例: Phase 1）
cp 店舗別包括ダッシュボード_v5.0_Phase1.backup_20251009_034111.ipynb \
   店舗別包括ダッシュボード_v5.0_Phase1.ipynb
```

### 再度修正スクリプトを実行

```bash
python3 scripts/fix_all_phase_notebooks.py
```

### サポート

- **GitHubのIssues**: https://github.com/yourusername/pycaret/issues
- **ドキュメント**:
  - `Phase_1_4_日本語対応ガイド.md`
  - `実務向けクイックスタート.md`
  - `修正完了サマリー.md`

---

## 📞 確認結果の報告

ノートブックの実行結果を以下の形式で報告いただけると助かります：

```
Phase 1: ✅ 正常動作 / ❌ エラー発生（詳細: ...)
Phase 2: ✅ 正常動作 / ❌ エラー発生（詳細: ...)
Phase 3: ✅ 正常動作 / ❌ エラー発生（詳細: ...)
Phase 4: ✅ 正常動作 / ❌ エラー発生（詳細: ...)

日本語表示: ✅ 正常 / ❌ 文字化け
店舗選択: ✅ 正常動作 / ❌ 表示されない
データ検証: ✅ メッセージ表示 / ❌ エラー

その他気づいた点:
...
```

---

**データドリブンな店舗運営を今日から始めましょう！** 🚀
