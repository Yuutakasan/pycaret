#!/usr/bin/env python3
"""
åŒ…æ‹¬çš„å£²ä¸Šã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆåˆ†æã®å¯è¦–åŒ–
æ ¼ç´ç‡80%ä»¥ä¸Šã®å…¨ç‰¹å¾´é‡ã«ã¤ã„ã¦è¦–è¦šçš„ã«è¡¨ç¤º
"""

import pandas as pd
from pathlib import Path

print("\n" + "="*80)
print("ğŸ“Š åŒ…æ‹¬çš„å£²ä¸Šã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆåˆ†æ - ãƒ†ã‚­ã‚¹ãƒˆå¯è¦–åŒ–")
print("="*80)

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
impact_df = pd.read_csv('output/comprehensive_sales_impact_analysis.csv', encoding='utf-8-sig')

# ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡ã®çµ¶å¯¾å€¤ã§ã‚½ãƒ¼ãƒˆ
impact_df['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡_çµ¶å¯¾å€¤'] = impact_df['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'].abs()
impact_df = impact_df.sort_values('ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡_çµ¶å¯¾å€¤', ascending=False)

print(f"\nâœ… åˆ†æå®Œäº†: {len(impact_df)}å€‹ã®ç‰¹å¾´é‡")

# ========================================
# 1. Top 20 å…¨ä½“ãƒ©ãƒ³ã‚­ãƒ³ã‚°
# ========================================
print("\n" + "="*80)
print("ğŸ† å£²ä¸Šã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚° Top 20")
print("="*80)
print(f"{'é †ä½':<4} {'ç‰¹å¾´é‡':<35} {'ã‚«ãƒ†ã‚´ãƒª':<12} {'ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡':<12} {'çµ¶å¯¾å€¤':<15} {'åˆ†æã‚¿ã‚¤ãƒ—':<20}")
print("-"*120)

for idx, row in enumerate(impact_df.head(20).iterrows(), 1):
    _, data = row
    impact_sign = '+' if data['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'] > 0 else ''
    print(f"{idx:<4} {data['ç‰¹å¾´é‡']:<35} {data['ã‚«ãƒ†ã‚´ãƒª']:<12} "
          f"{impact_sign}{data['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡']*100:>6.2f}% "
          f"{impact_sign}{data['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆçµ¶å¯¾å€¤']:>10,.0f}å††   "
          f"{data['åˆ†æã‚¿ã‚¤ãƒ—']:<20}")

# ========================================
# 2. æ­£ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ Top 10
# ========================================
print("\n" + "="*80)
print("âœ… å£²ä¸Šå¢—åŠ è¦å›  Top 10")
print("="*80)
positive = impact_df[impact_df['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'] > 0].head(10)

for idx, row in enumerate(positive.iterrows(), 1):
    _, data = row
    print(f"{idx:2d}. {data['ç‰¹å¾´é‡']:<35} "
          f"+{data['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡']*100:6.2f}% (+{data['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆçµ¶å¯¾å€¤']:,.0f}å††) "
          f"[{data['åˆ†æã‚¿ã‚¤ãƒ—']}] [{data['ã‚«ãƒ†ã‚´ãƒª']}]")

# ========================================
# 3. è² ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ Top 10
# ========================================
print("\n" + "="*80)
print("âš ï¸ å£²ä¸Šæ¸›å°‘è¦å›  Top 10")
print("="*80)
negative = impact_df[impact_df['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'] < 0].sort_values('ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡').head(10)

for idx, row in enumerate(negative.iterrows(), 1):
    _, data = row
    print(f"{idx:2d}. {data['ç‰¹å¾´é‡']:<35} "
          f"{data['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡']*100:+6.2f}% ({data['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆçµ¶å¯¾å€¤']:+,.0f}å††) "
          f"[{data['åˆ†æã‚¿ã‚¤ãƒ—']}] [{data['ã‚«ãƒ†ã‚´ãƒª']}]")

# ========================================
# 4. ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚µãƒãƒªãƒ¼
# ========================================
print("\n" + "="*80)
print("ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚µãƒãƒªãƒ¼")
print("="*80)

category_summary = impact_df.groupby('ã‚«ãƒ†ã‚´ãƒª').agg({
    'ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡_çµ¶å¯¾å€¤': ['mean', 'max', 'count']
}).round(4)
category_summary.columns = ['å¹³å‡ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡', 'æœ€å¤§ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡', 'ç‰¹å¾´é‡æ•°']
category_summary = category_summary.sort_values('æœ€å¤§ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡', ascending=False)

print(f"{'ã‚«ãƒ†ã‚´ãƒª':<12} {'å¹³å‡ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ':<15} {'æœ€å¤§ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ':<15} {'ç‰¹å¾´é‡æ•°':<10}")
print("-"*60)
for cat, row in category_summary.iterrows():
    print(f"{cat:<12} {row['å¹³å‡ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡']*100:>10.2f}%    "
          f"{row['æœ€å¤§ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡']*100:>10.2f}%    "
          f"{int(row['ç‰¹å¾´é‡æ•°']):>6}å€‹")

# ========================================
# 5. åˆ†æã‚¿ã‚¤ãƒ—åˆ¥åˆ†å¸ƒ
# ========================================
print("\n" + "="*80)
print("ğŸ“Š åˆ†æã‚¿ã‚¤ãƒ—åˆ¥åˆ†å¸ƒ")
print("="*80)

analysis_type_counts = impact_df['åˆ†æã‚¿ã‚¤ãƒ—'].value_counts()
total = len(impact_df)

print(f"{'åˆ†æã‚¿ã‚¤ãƒ—':<30} {'ä»¶æ•°':<10} {'å‰²åˆ':<10}")
print("-"*50)
for atype, count in analysis_type_counts.items():
    print(f"{atype:<30} {count:>6}å€‹   {count/total*100:>6.1f}%")

# ========================================
# 6. ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡ã®åˆ†å¸ƒçµ±è¨ˆ
# ========================================
print("\n" + "="*80)
print("ğŸ“ˆ ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡ã®çµ±è¨ˆ")
print("="*80)

print(f"\næ­£ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ: {(impact_df['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'] > 0).sum()}å€‹")
print(f"  å¹³å‡: +{impact_df[impact_df['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'] > 0]['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'].mean()*100:.2f}%")
print(f"  æœ€å¤§: +{impact_df['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'].max()*100:.2f}%")

print(f"\nè² ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ: {(impact_df['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'] < 0).sum()}å€‹")
print(f"  å¹³å‡: {impact_df[impact_df['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'] < 0]['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'].mean()*100:.2f}%")
print(f"  æœ€å°: {impact_df['ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡'].min()*100:.2f}%")

# ========================================
# 7. æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
# ========================================
print("\n" + "="*80)
print("ğŸ¯ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³")
print("="*80)

print("""
ã€å£²ä¸Šæœ€å¤§åŒ–æ–½ç­–ã€‘

1. è¶…é«˜ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¦å› ã®æ´»ç”¨ï¼ˆ+500%ä»¥ä¸Šï¼‰
   âœ“ å­£ç¯€å¤‰å‹•æŒ‡æ•°ã®ç›£è¦–ã¨æ´»ç”¨
   âœ“ å£²ä¸Šæ•°é‡ãƒˆãƒ¬ãƒ³ãƒ‰ã®äºˆæ¸¬
   âœ“ ã‚«ãƒ†ã‚´ãƒªåˆ¥åœ¨åº«æœ€é©åŒ–

2. æ­£ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¦å› ã®æœ€å¤§åŒ–ï¼ˆ+20-300%ï¼‰
   âœ“ æ°—æ¸©å·®æ‹¡å¤§æ™‚ã®åœ¨åº«ç¢ºä¿
   âœ“ å¯’æš–å¤‰åŒ–ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³
   âœ“ é€£ä¼‘ãƒ»æ›œæ—¥åˆ¥ã®è²©å£²å¼·åŒ–

3. è² ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¦å› ã®ç·©å’Œï¼ˆ-70%ï½-20%ï¼‰
   âœ“ å­£ç¯€ä¸Šæ˜‡æœŸã®ç‰¹åˆ¥æ–½ç­–
   âœ“ æš–ã‹ããªã£ãŸæ™‚ã®ä»£æ›¿å•†å“ææ¡ˆ
   âœ“ å¹³æ—¥ãƒ»ä¼‘æ—¥åˆ¥ã®ä¾¡æ ¼æˆ¦ç•¥

4. äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«ã¸ã®æ´»ç”¨
   âœ“ ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç‡ä¸Šä½20ç‰¹å¾´é‡ã‚’é‡ç‚¹ä½¿ç”¨
   âœ“ æ™‚ç³»åˆ—ãƒ»æ°—æ¸©ãƒ»ãƒ•ãƒ©ã‚°ã®ç›¸äº’ä½œç”¨é …ä½œæˆ
   âœ“ ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«é‡è¦ç‰¹å¾´é‡ã‚’é¸å®š
   âœ“ å­£ç¯€å¤‰å‹•æŒ‡æ•°ã®ç‰¹åˆ¥æ‰±ã„ï¼ˆ+797%ã®å½±éŸ¿åŠ›ï¼‰

5. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±åˆ
   âœ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç›£è¦–
   âœ“ ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
   âœ“ é€±æ¬¡ãƒ»æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ
""")

print("\n" + "="*80)
print("âœ… åŒ…æ‹¬çš„å£²ä¸Šã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆåˆ†æå®Œäº†")
print("="*80)
print(f"\nğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«:")
print(f"  - output/comprehensive_sales_impact_analysis.csv ({len(impact_df)}ç‰¹å¾´é‡)")
print(f"  - output/sales_impact_top50.csv (Top 50)")
print(f"  - åº—èˆ—åˆ¥åŒ…æ‹¬ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰_v6.1_ææ¡ˆå¼·åŒ–.ipynb (åˆ†æã‚»ãƒ«è¿½åŠ )")
print(f"\nğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
print(f"  1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§æœ€æ–°ã‚»ãƒ«ã‚’å®Ÿè¡Œ")
print(f"  2. äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«ã«ä¸Šä½ç‰¹å¾´é‡ã‚’çµ„ã¿è¾¼ã‚€")
print(f"  3. ã‚«ãƒ†ã‚´ãƒªåˆ¥æ–½ç­–ã®å®Ÿæ–½ã¨åŠ¹æœæ¸¬å®š")
print()
