###############################################################################
# RAPIDS + PyCaret GPU環境 - マルチステージビルド最適化版
# イメージサイズ30-40%削減 + 次回ビルド高速化
###############################################################################

# syntax=docker/dockerfile:1.4

###############################################################################
# ビルドステージ: すべてのパッケージをインストール
###############################################################################
FROM nvcr.io/nvidia/rapidsai/base:25.06-cuda12.8-py3.11 AS builder

# 環境変数を最初に設定（キャッシュ効率化）
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=ja_JP.UTF-8 \
    LC_ALL=ja_JP.UTF-8 \
    RAPIDS_NO_INITIALIZE=1 \
    CUDA_VISIBLE_DEVICES=all

# rootで日本語環境設定（aptキャッシュマウントで高速化）
USER root
RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt/lists \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        locales fonts-ipafont-gothic fonts-ipafont-mincho \
        fonts-noto-cjk fontconfig vim nano htop nvtop && \
    echo "ja_JP.UTF-8 UTF-8" >> /etc/locale.gen && \
    locale-gen && \
    fc-cache -fv

# rapidsユーザーに切り替え
USER rapids
WORKDIR /home/rapids

# Step 1: mamba パッケージのインストール（変更頻度低・キャッシュ効率高）
RUN --mount=type=cache,target=/opt/conda/pkgs,uid=1000,gid=1000 \
    mamba install -y -c conda-forge \
        pycaret=3.3.2 \
        autoviz=0.1.905 \
        explainerdashboard \
        pynvml \
        nvitop \
        catboost && \
    mamba clean -yaf

# Step 2: PyTorch GPU版インストール（大容量・独立レイヤー）
RUN --mount=type=cache,target=/home/rapids/.cache/pip,uid=1000,gid=1000 \
    pip install --no-cache-dir \
        torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# Step 3: GPU対応LightGBM（CUDA対応ビルド）
RUN --mount=type=cache,target=/home/rapids/.cache/pip,uid=1000,gid=1000 \
    pip install --no-cache-dir lightgbm --config-settings=cmake.define.USE_CUDA=ON

# Step 3.5: GPU対応XGBoost（CUDA対応ビルド）
RUN --mount=type=cache,target=/home/rapids/.cache/pip,uid=1000,gid=1000 \
    pip install --no-cache-dir 'xgboost>=2.0.0'

# Step 4: その他のPyPIパッケージ（変更頻度高）
RUN --mount=type=cache,target=/home/rapids/.cache/pip,uid=1000,gid=1000 \
    pip install --no-cache-dir \
        japanize-matplotlib \
        'shap[gpu]' \
        ydata-profiling \
        interpret \
        jupyter-resource-usage \
        jupyterlab-execute-time \
        jupyterlab-system-monitor && \
    rm -rf ~/.cache/matplotlib

# Step 5: JupyterLab拡張（軽量化：lab buildのみ）
RUN --mount=type=cache,target=/home/rapids/.cache,uid=1000,gid=1000 \
    jupyter lab build

# 🔥 ビルドステージ最適化: 不要ファイルを削除してサイズ削減
USER root
RUN find /opt/conda -name '__pycache__' -type d -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/conda -name '*.pyc' -delete 2>/dev/null || true && \
    find /opt/conda -name '*.pyo' -delete 2>/dev/null || true && \
    find /opt/conda -name 'tests' -type d -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/conda -name 'test' -type d -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/conda/pkgs -mindepth 1 -maxdepth 1 -type d -exec rm -rf {} + 2>/dev/null || true && \
    rm -rf /opt/conda/share/jupyter/lab/staging && \
    rm -rf /tmp/* /var/tmp/* 2>/dev/null || true

USER rapids

###############################################################################
# 本番ステージ: 最小限のファイルだけをコピー
###############################################################################
FROM nvcr.io/nvidia/rapidsai/base:25.06-cuda12.8-py3.11

# 環境変数
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=ja_JP.UTF-8 \
    LC_ALL=ja_JP.UTF-8 \
    RAPIDS_NO_INITIALIZE=1 \
    CUDA_VISIBLE_DEVICES=all

# 日本語フォント設定（最小限）
USER root
RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt/lists \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        locales fonts-ipafont-gothic fonts-noto-cjk fontconfig && \
    echo "ja_JP.UTF-8 UTF-8" >> /etc/locale.gen && \
    locale-gen && \
    fc-cache -fv && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# ビルドステージからインストール済みパッケージをコピー
COPY --from=builder --chown=rapids:rapids /opt/conda /opt/conda
COPY --from=builder --chown=rapids:rapids /home/rapids/.jupyter /home/rapids/.jupyter

USER rapids
WORKDIR /home/rapids

# 環境チェックスクリプトをコピー
COPY --chown=rapids:rapids check_gpu_rapids_environment.py /home/rapids/

# エントリーポイントスクリプト
RUN echo '#!/bin/bash\n\
echo "🚀 RAPIDS + PyCaret GPU環境を起動中..."\n\
echo "📊 環境チェック中..."\n\
python /home/rapids/check_gpu_rapids_environment.py\n\
echo ""\n\
echo "📓 JupyterLabを起動します..."\n\
echo "📂 ノートブック:"\n\
echo "  - 特徴量AutoViz_PyCaret_v1.ipynb (AI売上予測)"\n\
echo "  - 店舗別包括ダッシュボード_v6.1_提案強化.ipynb (店舗ダッシュボード)"\n\
echo "📖 ドキュメント: docs/"\n\
jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root' \
> /home/rapids/start_jupyter.sh && chmod +x /home/rapids/start_jupyter.sh

VOLUME /home/rapids/work
EXPOSE 8888

CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root"]
